#!/bin/bash
#===============================================================================
# JPS Regen Password - Regenerate WordPress Admin Password and Update Credentials
#
# Regenerates the WordPress admin password and updates CREDENTIALS.txt
#
# Usage:
#   jps-regen-password <domain>              # Regenerate password
#   jps-regen-password <domain> --user bob   # Regenerate for specific user
#   jps-regen-password <domain> --show       # Show current credentials (no change)
#
# Exit Codes:
#   0 - Success
#   1 - Error
#   2 - Invalid arguments
#===============================================================================

set -eo pipefail

# Script metadata
readonly SCRIPT_NAME="jps-regen-password"
readonly SCRIPT_VERSION="1.0.0"

# Resolve the actual script location (handle symlinks)
_resolve_script_dir() {
    local source="${BASH_SOURCE[0]}"
    while [[ -L "$source" ]]; do
        local dir
        dir=$(cd -P "$(dirname "$source")" && pwd)
        source=$(readlink "$source")
        [[ $source != /* ]] && source="$dir/$source"
    done
    cd -P "$(dirname "$source")" && pwd
}

readonly SCRIPT_DIR="$(_resolve_script_dir)"
readonly INSTALL_DIR="$(dirname "$SCRIPT_DIR")"

# Source common library
if [[ -f "${INSTALL_DIR}/lib/jps-common.sh" ]]; then
    # shellcheck source=../lib/jps-common.sh
    source "${INSTALL_DIR}/lib/jps-common.sh"
else
    echo "[CRIT] Cannot find jps-common.sh library" >&2
    exit 2
fi

# Load configuration
load_config

#===============================================================================
# HELP AND VERSION
#===============================================================================

show_help() {
    cat << 'EOF'
JPS Regen Password - Regenerate WordPress Admin Password

DESCRIPTION:
    Regenerates the WordPress admin password and updates CREDENTIALS.txt
    to keep credentials in sync.

USAGE:
    jps-regen-password <domain> [OPTIONS]

ARGUMENTS:
    domain              The domain to update (e.g., example.com)

OPTIONS:
    -h, --help          Show this help message
    -V, --version       Show version information
    -u, --user USER     WordPress username to update (default: first admin)
    -s, --show          Show current credentials without changing
    -q, --quiet         Only output the new password (for scripts)
    --json              Output result as JSON

EXAMPLES:
    # Regenerate password for default admin
    jps-regen-password example.com

    # Regenerate for specific user
    jps-regen-password example.com --user admin

    # Show current credentials
    jps-regen-password example.com --show

EXIT CODES:
    0 - Success
    1 - Error
    2 - Invalid arguments

For more information, see: https://github.com/yourusername/jps-server-tools
EOF
}

#===============================================================================
# GLOBAL VARIABLES
#===============================================================================

DOMAIN=""
TARGET_USER=""
SHOW_ONLY=false
QUIET=false
JSON_OUTPUT=false

#===============================================================================
# ARGUMENT PARSING
#===============================================================================

parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                show_help
                exit 0
                ;;
            -V|--version)
                show_version
                exit 0
                ;;
            -u|--user)
                if [[ -z "${2:-}" ]]; then
                    error "Option --user requires an argument"
                    exit 2
                fi
                TARGET_USER="$2"
                shift 2
                ;;
            -s|--show)
                SHOW_ONLY=true
                shift
                ;;
            -q|--quiet)
                QUIET=true
                shift
                ;;
            --json)
                JSON_OUTPUT=true
                shift
                ;;
            -*)
                error "Unknown option: $1"
                echo "Use --help for usage information" >&2
                exit 2
                ;;
            *)
                if [[ -z "$DOMAIN" ]]; then
                    DOMAIN="$1"
                else
                    error "Unexpected argument: $1"
                    exit 2
                fi
                shift
                ;;
        esac
    done

    # Validate domain is provided
    if [[ -z "$DOMAIN" ]]; then
        error "Domain is required"
        echo "Usage: jps-regen-password <domain> [OPTIONS]"
        exit 2
    fi
}

#===============================================================================
# MAIN FUNCTIONS
#===============================================================================

# Get the first WordPress admin user
get_admin_user() {
    local doc_root="$1"

    # Get first user with administrator role
    wp --path="$doc_root" --allow-root user list \
        --role=administrator \
        --field=user_login \
        --number=1 2>/dev/null | head -1
}

# Get user email
get_user_email() {
    local doc_root="$1"
    local username="$2"

    wp --path="$doc_root" --allow-root user get "$username" \
        --field=user_email 2>/dev/null
}

# Show current credentials
show_credentials() {
    local site_dir="${WEBSITES_ROOT}/${DOMAIN}"
    local doc_root="${site_dir}/html"
    local creds_file="${site_dir}/CREDENTIALS.txt"

    # Check site exists
    if [[ ! -d "$doc_root" ]]; then
        error "Site not found: $DOMAIN"
        exit 1
    fi

    # Check WordPress exists
    if [[ ! -f "${doc_root}/wp-config.php" ]]; then
        error "WordPress not found at $doc_root"
        exit 1
    fi

    if [[ "$JSON_OUTPUT" == true ]]; then
        # Get info from WordPress
        local username
        if [[ -n "$TARGET_USER" ]]; then
            username="$TARGET_USER"
        else
            username=$(get_admin_user "$doc_root")
        fi

        local email
        email=$(get_user_email "$doc_root" "$username" 2>/dev/null || echo "")

        local site_url
        site_url=$(wp --path="$doc_root" --allow-root option get siteurl 2>/dev/null || echo "https://${DOMAIN}")

        # Check if CREDENTIALS.txt exists
        local has_creds="false"
        if [[ -f "$creds_file" ]]; then
            has_creds="true"
        fi

        cat << EOF
{
  "domain": "$DOMAIN",
  "username": "$username",
  "email": "$email",
  "site_url": "$site_url",
  "credentials_file": "$has_creds",
  "note": "Password not shown for security"
}
EOF
    else
        header "Current Credentials for $DOMAIN"
        echo ""

        if [[ -f "$creds_file" ]]; then
            echo "CREDENTIALS.txt contents:"
            echo "========================="
            cat "$creds_file"
        else
            warn "No CREDENTIALS.txt found at $creds_file"
            echo ""
            echo "WordPress admin users:"
            wp --path="$doc_root" --allow-root user list \
                --role=administrator \
                --fields=ID,user_login,user_email 2>/dev/null || true
        fi
    fi
}

# Regenerate password and update credentials
regen_password() {
    local site_dir="${WEBSITES_ROOT}/${DOMAIN}"
    local doc_root="${site_dir}/html"
    local creds_file="${site_dir}/CREDENTIALS.txt"

    # Check site exists
    if [[ ! -d "$doc_root" ]]; then
        error "Site not found: $DOMAIN"
        exit 1
    fi

    # Check WordPress exists
    if [[ ! -f "${doc_root}/wp-config.php" ]]; then
        error "WordPress not found at $doc_root"
        exit 1
    fi

    # Determine target user
    local username
    if [[ -n "$TARGET_USER" ]]; then
        username="$TARGET_USER"
        # Verify user exists
        if ! wp --path="$doc_root" --allow-root user get "$username" &>/dev/null; then
            error "User '$username' not found in WordPress"
            exit 1
        fi
    else
        username=$(get_admin_user "$doc_root")
        if [[ -z "$username" ]]; then
            error "No administrator user found in WordPress"
            exit 1
        fi
    fi

    # Generate new password
    local new_password
    new_password=$(random_string 16)

    # Update WordPress user password
    if ! wp --path="$doc_root" --allow-root user update "$username" --user_pass="$new_password" 2>/dev/null; then
        error "Failed to update WordPress password"
        exit 1
    fi

    # Get additional info for credentials file
    local email
    email=$(get_user_email "$doc_root" "$username" 2>/dev/null || echo "")

    local site_url
    site_url=$(wp --path="$doc_root" --allow-root option get siteurl 2>/dev/null || echo "https://${DOMAIN}")

    # Get database info
    local db_info db_name db_user db_pass
    if db_info=$(get_wp_db_info "$doc_root" 2>/dev/null); then
        eval "$db_info"
        db_name="${DB_NAME:-}"
        db_user="${DB_USER:-}"
        db_pass="${DB_PASS:-}"
    fi

    # Update CREDENTIALS.txt
    cat > "$creds_file" << EOF
================================================================================
                         WORDPRESS SITE CREDENTIALS
================================================================================
Domain:         ${DOMAIN}
Site URL:       ${site_url}
Admin URL:      ${site_url}/wp-admin/

--------------------------------------------------------------------------------
                            WORDPRESS ADMIN
--------------------------------------------------------------------------------
Username:       ${username}
Password:       ${new_password}
Email:          ${email}

--------------------------------------------------------------------------------
                              DATABASE
--------------------------------------------------------------------------------
Database:       ${db_name:-N/A}
DB User:        ${db_user:-N/A}
DB Password:    ${db_pass:-[check wp-config.php]}

--------------------------------------------------------------------------------
                              FILE PATHS
--------------------------------------------------------------------------------
Site Root:      ${site_dir}/
Document Root:  ${doc_root}/
Logs:           ${site_dir}/logs/
VHost Config:   ${VHOSTS_DIR}/${DOMAIN}/vhconf.conf

================================================================================
IMPORTANT: Keep this file secure! It contains sensitive credentials.
Password regenerated: $(date '+%Y-%m-%d %H:%M:%S')
================================================================================
EOF

    # Secure the credentials file
    chown root:nogroup "$creds_file"
    chmod 640 "$creds_file"

    # Output result
    if [[ "$JSON_OUTPUT" == true ]]; then
        cat << EOF
{
  "success": true,
  "domain": "$DOMAIN",
  "username": "$username",
  "password": "$new_password",
  "email": "$email",
  "site_url": "$site_url",
  "credentials_file": "$creds_file"
}
EOF
    elif [[ "$QUIET" == true ]]; then
        echo "$new_password"
    else
        success "Password regenerated for $username"
        echo ""
        echo "New Credentials:"
        echo "  Username: $username"
        echo "  Password: $new_password"
        echo "  Login:    ${site_url}/wp-admin/"
        echo ""
        echo "CREDENTIALS.txt updated at: $creds_file"
    fi
}

#===============================================================================
# MAIN EXECUTION
#===============================================================================

main() {
    # Parse command line arguments
    parse_args "$@"

    # Check for root privileges
    require_root

    if [[ "$SHOW_ONLY" == true ]]; then
        show_credentials
    else
        regen_password
    fi
}

# Run main function
main "$@"
