#!/bin/bash
#===============================================================================
# JPS DNS Check - Verify domain DNS configuration
#
# Checks if a domain's A record points to the expected VPS IP address.
# Used by the deployment wizard to verify DNS before site creation.
#
# Usage:
#   jps-dns-check domain.com           # Check DNS for domain
#   jps-dns-check --ip 1.2.3.4 domain  # Check against specific IP
#   jps-dns-check --json domain.com    # JSON output
#
# Exit Codes:
#   0 - DNS correctly configured
#   1 - DNS mismatch or not configured
#   2 - Invalid arguments or error
#===============================================================================

set -euo pipefail

# Script metadata
readonly SCRIPT_NAME="jps-dns-check"
readonly SCRIPT_VERSION="1.0.0"

# Default VPS IP (can be overridden via --ip or config)
readonly DEFAULT_VPS_IP="69.62.67.12"

# Resolve the actual script location (handle symlinks)
_resolve_script_dir() {
    local source="${BASH_SOURCE[0]}"
    while [[ -L "$source" ]]; do
        local dir
        dir=$(cd -P "$(dirname "$source")" && pwd)
        source=$(readlink "$source")
        [[ $source != /* ]] && source="$dir/$source"
    done
    cd -P "$(dirname "$source")" && pwd
}

readonly SCRIPT_DIR="$(_resolve_script_dir)"
readonly INSTALL_DIR="$(dirname "$SCRIPT_DIR")"

# Source common library
if [[ -f "${INSTALL_DIR}/lib/jps-common.sh" ]]; then
    # shellcheck source=../lib/jps-common.sh
    source "${INSTALL_DIR}/lib/jps-common.sh"
else
    echo "[ERROR] Cannot find jps-common.sh library" >&2
    exit 2
fi

# Load configuration
load_config

#===============================================================================
# HELP AND VERSION
#===============================================================================

show_help() {
    cat << 'EOF'
JPS DNS Check - Verify domain DNS configuration

DESCRIPTION:
    Checks if a domain's A record points to the expected VPS IP address.
    Used by the deployment wizard to verify DNS before site creation.

USAGE:
    jps-dns-check [OPTIONS] <domain>

OPTIONS:
    -h, --help          Show this help message
    -V, --version       Show version information
    -j, --json          Output results as JSON
    -i, --ip IP         Expected IP address (default: 69.62.67.12)
    -q, --quiet         Suppress output, only return exit code

EXAMPLES:
    # Check if domain points to VPS
    jps-dns-check example.com

    # Check with JSON output
    jps-dns-check --json example.com

    # Check against specific IP
    jps-dns-check --ip 192.168.1.100 example.com

EXIT CODES:
    0 - DNS correctly configured (A record matches expected IP)
    1 - DNS mismatch (A record points elsewhere or not set)
    2 - Invalid arguments or error

OUTPUT (JSON):
    {
        "status": "ok|mismatch|error",
        "domain": "example.com",
        "resolved_ip": "69.62.67.12",
        "expected_ip": "69.62.67.12",
        "message": "DNS configured correctly"
    }
EOF
}

show_version() {
    echo "$SCRIPT_NAME version $SCRIPT_VERSION"
}

#===============================================================================
# GLOBAL VARIABLES
#===============================================================================

DOMAIN=""
EXPECTED_IP="$DEFAULT_VPS_IP"
JSON_OUTPUT=false
QUIET=false

#===============================================================================
# ARGUMENT PARSING
#===============================================================================

parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                show_help
                exit 0
                ;;
            -V|--version)
                show_version
                exit 0
                ;;
            -j|--json)
                JSON_OUTPUT=true
                shift
                ;;
            -i|--ip)
                if [[ -z "${2:-}" ]]; then
                    error "Option --ip requires an IP address"
                    exit 2
                fi
                EXPECTED_IP="$2"
                shift 2
                ;;
            -q|--quiet)
                QUIET=true
                shift
                ;;
            -*)
                error "Unknown option: $1"
                echo "Use --help for usage information" >&2
                exit 2
                ;;
            *)
                if [[ -z "$DOMAIN" ]]; then
                    DOMAIN="$1"
                else
                    error "Unexpected argument: $1"
                    exit 2
                fi
                shift
                ;;
        esac
    done

    # Validate required arguments
    if [[ -z "$DOMAIN" ]]; then
        error "Domain name is required"
        echo "Usage: $SCRIPT_NAME [OPTIONS] <domain>"
        exit 2
    fi

    # Validate domain format (basic check)
    if ! [[ "$DOMAIN" =~ ^[a-zA-Z0-9]([a-zA-Z0-9-]*\.)+[a-zA-Z]{2,}$ ]]; then
        output_result "error" "" "Invalid domain format: $DOMAIN"
        exit 2
    fi

    # Validate IP format (basic check)
    if ! [[ "$EXPECTED_IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        output_result "error" "" "Invalid IP format: $EXPECTED_IP"
        exit 2
    fi
}

#===============================================================================
# FUNCTIONS
#===============================================================================

# Output result in appropriate format
output_result() {
    local status="$1"
    local resolved_ip="$2"
    local message="$3"

    if [[ "$JSON_OUTPUT" == true ]]; then
        # JSON output
        cat << EOF
{
    "status": "$status",
    "domain": "$DOMAIN",
    "resolved_ip": "${resolved_ip:-null}",
    "expected_ip": "$EXPECTED_IP",
    "message": "$message"
}
EOF
    elif [[ "$QUIET" != true ]]; then
        # Human-readable output
        case "$status" in
            ok)
                success "$message"
                ;;
            mismatch)
                warn "$message"
                ;;
            error)
                error "$message"
                ;;
        esac
    fi
}

# Check DNS A record for domain
check_dns() {
    local resolved_ip=""

    # Check if dig command exists
    if ! command_exists dig; then
        # Fall back to host command
        if command_exists host; then
            resolved_ip=$(host -t A "$DOMAIN" 2>/dev/null | grep -oP 'has address \K[0-9.]+' | head -1)
        else
            # Last resort: nslookup
            if command_exists nslookup; then
                resolved_ip=$(nslookup "$DOMAIN" 2>/dev/null | grep -A1 "Name:" | grep "Address:" | awk '{print $2}' | head -1)
            else
                output_result "error" "" "No DNS lookup tool found (dig, host, or nslookup required)"
                exit 2
            fi
        fi
    else
        # Use dig (preferred)
        resolved_ip=$(dig +short "$DOMAIN" A 2>/dev/null | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' | head -1)
    fi

    # Check if we got a result
    if [[ -z "$resolved_ip" ]]; then
        output_result "mismatch" "" "No A record found for $DOMAIN"
        return 1
    fi

    # Compare with expected IP
    if [[ "$resolved_ip" == "$EXPECTED_IP" ]]; then
        output_result "ok" "$resolved_ip" "DNS configured correctly - $DOMAIN resolves to $resolved_ip"
        return 0
    else
        output_result "mismatch" "$resolved_ip" "DNS mismatch - $DOMAIN resolves to $resolved_ip (expected $EXPECTED_IP)"
        return 1
    fi
}

#===============================================================================
# MAIN EXECUTION
#===============================================================================

main() {
    parse_args "$@"
    check_dns
}

# Run main function
main "$@"
